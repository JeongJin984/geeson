<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CMD Chat UI</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: black;
            color: #00ff00;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chat-box {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        #input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #00ff00;
        }

        #prompt {
            margin-right: 5px;
        }

        #cmd-input {
            background-color: black;
            color: #00ff00;
            border: none;
            outline: none;
            font-family: monospace;
            width: 100%;
        }

        #cmd-input:focus {
            border-bottom: 1px solid #00ff00;
        }
    </style>
</head>
<body>
<label for="order-host"></label><input id="order-host" hidden="hidden" th:value="${orderHost}">
<div id="chat-box">
    > Welcome to the CMD Chat
</div>

<div id="input-container">
    <div id="prompt">&gt;</div>
    <input type="text" id="cmd-input" autocomplete="off" />
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const cmdInput = document.getElementById('cmd-input');
    const orderHost = document.getElementById('order-host').value

    function appendLine(text, isUser = false) {
        const line = isUser ? `> ${text}` : text;
        chatBox.innerText += `\n${line}`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    cmdInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const input = cmdInput.value.trim();
            if (!input) return;

            appendLine(input, true);
            cmdInput.value = '';

            let fullCommand = input.split(" ")
            let command = fullCommand[0]
            let body = {}

            appendLine(input, true);
            cmdInput.value = '';

            let host = ""
            let url = ""
            let method = ""

            if(command === 'register-order') {
                host = orderHost
                method = 'POST'
                url = "/api/v1/orders"

                if(fullCommand.length <= 1) {
                    appendLine("no body exist", false);
                } else if(fullCommand.length > 1) {
                    body = fullCommand[1]
                }
            }

            if(command === 'show-order') {
                host = orderHost
                method = 'GET'
                url = "/api/v1/orders"
            }

            console.log("full path: " + host + url)
            console.log("body: " + body)

            if(method === 'POST') {
                fetch(host + url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                })
                    .then(res => res.json())
                    .then(data => appendLine(data || '(no response)'))
                    .catch(err => appendLine('Error: ' + err.message));
            } else if(method === 'GET') {
                $.ajax({
                    url: host + url,
                    type: method,
                    dataType: 'json',
                    success: (data) => {
                        appendLine(JSON.stringify(data) || '(no response)')
                    },
                    error: (xhr, status, error) => {
                        appendLine('Error: ' + err)
                    }
                })
            }


        }
    });

    // 입력창 항상 focus 유지
    function keepFocus() {
        if (document.activeElement !== cmdInput) {
            cmdInput.focus();
        }
    }

    setInterval(keepFocus, 100);
    window.onload = () => cmdInput.focus();
</script>

</body>
</html>